{% extends 'partials/base.html.twig' %}

{% block content %}
{% include 'partials/skn/flex-loader.html.twig' %}

{# Récupérer le slug de la room depuis l'URL #}
{% set path_parts = uri.path|split('/') %}
{% set room_slug = path_parts|last %}
{% set room = rooms[room_slug]|default(null) %}

<div class="skn-page-content">
    {% include 'partials/atoms/flash-messages.html.twig' ignore missing %}
    
    {% if room %}
        {# Variables de la room #}
        {% set room_name = room.name|default('Sans nom') %}
        {% set room_desc = room.description|default('') %}
        {% set room_admins = room.admins|default([]) %}
        {% set room_members = room.members|default([]) %}

        {# Compter les membres uniques (éviter doublons admin/membre) #}
        {% set all_unique_members = [] %}
        
        {# Normalisation en minuscules pour comparaison #}
        {% set current_user = grav.user %}
        {% set current_username_lower = current_user.username|lower %}
        {% set room_admins_lower = [] %}
        {% set room_members_lower = [] %}
        
        {% for u in room_admins %}
            {% set u_lower = u|lower %}
            {% set room_admins_lower = room_admins_lower|merge([u_lower]) %}
            {% set all_unique_members = all_unique_members|merge([u]) %}
        {% endfor %}
        
        {% for u in room_members %}
            {% set u_lower = u|lower %}
            {% set room_members_lower = room_members_lower|merge([u_lower]) %}
            {% if u not in all_unique_members %}
                {% set all_unique_members = all_unique_members|merge([u]) %}
            {% endif %}
        {% endfor %}
        
        {% set is_member = is_logged_in and (current_username_lower in room_members_lower or current_username_lower in room_admins_lower) %}
        {% set is_admin = is_logged_in and (current_username_lower in room_admins_lower) %}
        
        {% set total_members = all_unique_members|length %}
        
        {# Demandes d'adhésion #}
        {% set my_request_key = room_slug ~ '_' ~ current_user.username %}
        {% set my_request = membership_requests[my_request_key]|default(null) %}
        {% set has_pending_request = my_request and my_request.status == 'pending' %}
        
        {# Collecter les demandes en attente #}
        {% set pending_requests = [] %}
        {% for key, req in membership_requests if req.space_slug == room_slug and req.status == 'pending' %}
            {% set pending_requests = pending_requests|merge([{key: key, data: req}]) %}
        {% endfor %}

        {# ========== HEADER ========== #}
        {% include 'partials/skn/room-header.html.twig' with {
            room: room,
            room_name: room_name,
            room_slug: room_slug,
            total_members: total_members,
            is_logged_in: is_logged_in,
            is_admin: is_admin,
            is_member: is_member,
            has_pending_request: has_pending_request,
            uri: uri
        } %}

        {# ========== DESCRIPTION ========== #}
        {% if room_desc %}
            <section class="skn-room-description">
                <p>{{ room_desc|nl2br }}</p>
            </section>
        {% endif %}

        {# ========== VOTES EN COURS (membres uniquement) ========== #}
        {% if is_member and pending_requests|length > 0 %}
            {% include 'partials/skn/vote-panel.html.twig' with {
                requests: pending_requests,
                total_members: total_members,
                current_user: current_user
            } %}
        {% endif %}

        {# ========== MA DEMANDE EN COURS (non-membres) ========== #}
        {% if not is_member and has_pending_request %}
            {% include 'partials/skn/request-status.html.twig' with {
                request: my_request,
                total_members: total_members,
                room_slug: room_slug
            } %}
        {% endif %}

        {# ========== CHAT EXTERNE (PUBLIC) ========== #}
        {% include 'partials/skn/chat-box.html.twig' with {
            type: 'external',
            title: 'Discussion publique',
            icon: 'globe',
            badge: 'Visible par tous',
            room_slug: room_slug,
            messages: messages,
            can_write: is_logged_in,
            is_logged_in: is_logged_in,
            placeholder: 'Poser une question...'
        } %}

        {# ========== CHAT INTERNE (MEMBRES) ========== #}
        {% include 'partials/skn/chat-box.html.twig' with {
            type: 'internal',
            title: 'Discussion interne',
            icon: 'lock',
            badge: 'Membres uniquement',
            room_slug: room_slug,
            messages: messages,
            can_write: is_member,
            can_view: is_member,
            is_logged_in: is_logged_in,
            placeholder: 'Message aux membres...',
            locked_message: has_pending_request ? 'Votre demande est en cours de vote' : 'Devenez membre pour accéder'
        } %}

        {# ========== MEMBRES ========== #}
        {% include 'partials/skn/members-list.html.twig' with {
            admins: room_admins,
            members: room_members
        } %}

    {% else %}
        <div class="skn-empty-state">
            <i class="la la-question-circle"></i>
            <h2>Room introuvable</h2>
            <p>Cette room n'existe pas.</p>
            <a href="/explore" class="skn-btn skn-btn--primary">Explorer</a>
        </div>
    {% endif %}
</div>
{% endblock %}
